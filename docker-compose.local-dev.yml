version: "3.9"

services:
  db:
    image: clickhouse/clickhouse-server:24.8
    container_name: gpw-clickhouse
    restart: unless-stopped
    ports:
      - "${CLICKHOUSE_HTTP_PORT:-8123}:8123"
      - "${CLICKHOUSE_TCP_PORT:-9000}:9000"
    environment:
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-default}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-clickhouse}
      CLICKHOUSE_DB: ${CLICKHOUSE_DATABASE:-gpw}
    volumes:
      - ./.docker/clickhouse-data:/var/lib/clickhouse
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "clickhouse-client --host localhost --user ${CLICKHOUSE_USER:-default} --password ${CLICKHOUSE_PASSWORD:-clickhouse} --query 'SELECT 1'",
        ]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s

  backend:
    build:
      context: ./backend
    container_name: gpw-backend
    depends_on:
      db:
        condition: service_healthy
    env_file:
      - .env.local
    environment:
      BACKEND_PORT: ${BACKEND_PORT:-8000}
      CLICKHOUSE_URL: ${CLICKHOUSE_URL:-http://default:clickhouse@db:8123/gpw}
      CLICKHOUSE_HOST: ${CLICKHOUSE_HOST:-db}
      CLICKHOUSE_PORT: ${CLICKHOUSE_PORT:-9000}
      CLICKHOUSE_DATABASE: ${CLICKHOUSE_DATABASE:-gpw}
      CLICKHOUSE_USER: ${CLICKHOUSE_USER:-default}
      CLICKHOUSE_PASSWORD: ${CLICKHOUSE_PASSWORD:-clickhouse}
      CLICKHOUSE_SECURE: ${CLICKHOUSE_SECURE:-false}
      CLICKHOUSE_VERIFY: ${CLICKHOUSE_VERIFY:-false}
    ports:
      - "${BACKEND_PORT:-8000}:8000"
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      args:
        NEXT_PUBLIC_API_BASE: ${NEXT_PUBLIC_API_BASE:-http://backend:8000}
    container_name: gpw-frontend
    depends_on:
      - backend
    env_file:
      - .env.local
    environment:
      NEXT_PUBLIC_API_BASE: ${NEXT_PUBLIC_API_BASE:-http://backend:8000}
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    restart: unless-stopped
